<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>3D 體型模擬器</title>
    <style>
        body { margin: 0; display: flex; font-family: sans-serif; background: #2c3e50; color: white; }
        #ui-panel { width: 300px; padding: 20px; background: rgba(0,0,0,0.8); z-index: 10; height: 100vh; box-sizing: border-box; }
        #canvas-container { flex-grow: 1; height: 100vh; position: relative; }
        .input-group { margin-bottom: 20px; }
        select { width: 100%; padding: 10px; border-radius: 5px; margin-top: 5px; }
        label { font-size: 14px; color: #bdc3c7; }
        h2 { border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        #bmi-info { margin-top: 30px; padding: 15px; background: #34495e; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>

<div id="ui-panel">
    <h2>3D 人物設定</h2>
    
    <div class="input-group">
        <label>性別</label>
        <select id="gender">
            <option value="male">男性 (寬肩)</option>
            <option value="female">女性 (寬臀)</option>
        </select>
    </div>

    <div class="input-group">
        <label>身高 (cm)</label>
        <select id="height"></select>
    </div>

    <div class="input-group">
        <label>體重 (kg)</label>
        <select id="weight"></select>
    </div>

    <div id="bmi-info">
        <div>當前 BMI</div>
        <div id="bmi-val" style="font-size: 24px; font-weight: bold; color: #2ecc71;">--</div>
    </div>
    
    <p style="font-size: 12px; color: #7f8c8d; margin-top: 20px;">* 使用滑鼠左鍵旋轉、滾輪縮放</p>
</div>

<div id="canvas-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
    let scene, camera, renderer, character, torso, head, lArm, rArm, lLeg, rLeg, controls;

    function init() {
        // 1. 場景設定
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x2c3e50);

        // 2. 攝影機
        camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 300) / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.5, 4);

        // 3. 渲染器
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth - 300, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // 4. 燈光
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(1, 1, 2);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        // 5. 建立人物組合
        character = new THREE.Group();
        const mat = new THREE.MeshPhongMaterial({ color: 0xe0ac69 }); // 膚色

        // 軀幹
        torso = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 0.5), mat);
        torso.position.y = 1.2;
        character.add(torso);

        // 頭部
        head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 32, 32), mat);
        head.position.y = 2.1;
        character.add(head);

        // 手腳 (簡化呈現)
        const limbGeo = new THREE.CylinderGeometry(0.1, 0.1, 1, 16);
        lArm = new THREE.Mesh(limbGeo, mat); lArm.position.set(-0.6, 1.3, 0);
        rArm = new THREE.Mesh(limbGeo, mat); rArm.position.set(0.6, 1.3, 0);
        lLeg = new THREE.Mesh(limbGeo, mat); lLeg.position.set(-0.3, 0.5, 0);
        rLeg = new THREE.Mesh(limbGeo, mat); rLeg.position.set(0.3, 0.5, 0);
        
        character.add(lArm, rArm, lLeg, rLeg);
        scene.add(character);

        // 控制器
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        
        // 初始化下拉選單
        const hSelect = document.getElementById('height');
        const wSelect = document.getElementById('weight');
        for(let i=150; i<=180; i++) hSelect.add(new Option(i, i));
        for(let i=40; i<=90; i++) wSelect.add(new Option(i, i));
        hSelect.value = 165; wSelect.value = 60;

        // 監聽事件
        [hSelect, wSelect, document.getElementById('gender')].forEach(el => {
            el.addEventListener('change', updateBody);
        });

        window.addEventListener('resize', onWindowResize);
        updateBody();
        animate();
    }

    function updateBody() {
        const h = parseInt(document.getElementById('height').value);
        const w = parseInt(document.getElementById('weight').value);
        const gender = document.getElementById('gender').value;

        // 計算 BMI
        const bmi = (w / ((h/100)**2)).toFixed(1);
        document.getElementById('bmi-val').innerText = bmi;

        // 基礎比例 (165cm, 60kg 為基準 1.0)
        const hScale = h / 165;
        const wScale = w / 60;

        // 調整人物整體高度
        character.scale.set(1, hScale, 1);

        // 根據體重調整軀幹與四肢的粗細 (寬度與厚度)
        // 考慮到體重增加不只是變寬，也會變厚
        const thickness = Math.sqrt(wScale); 
        torso.scale.set(thickness, 1, thickness);
        
        // 性別特徵微調
        if(gender === 'female') {
            // 女性：肩膀稍窄，臀部加寬
            torso.geometry = new THREE.CylinderGeometry(0.4 * thickness, 0.6 * thickness, 1.5, 4);
            torso.rotation.y = Math.PI / 4; // 轉向正面
        } else {
            // 男性：倒三角形，肩膀寬
            torso.geometry = new THREE.CylinderGeometry(0.6 * thickness, 0.4 * thickness, 1.5, 4);
            torso.rotation.y = Math.PI / 4;
        }

        // 調整手腳粗細
        [lArm, rArm, lLeg, rLeg].forEach(limb => {
            limb.scale.set(thickness, 1, thickness);
        });
        
        // 動態調整手的位置 (避免穿模)
        lArm.position.x = -0.4 - (0.2 * thickness);
        rArm.position.x = 0.4 + (0.2 * thickness);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    function onWindowResize() {
        camera.aspect = (window.innerWidth - 300) / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth - 300, window.innerHeight);
    }

    init();
</script>

</body>
</html>
