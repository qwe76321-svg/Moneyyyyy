<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>3D çœŸäººç©¿æ­æ¨¡æ“¬å™¨</title>
    <style>
        body { margin: 0; font-family: 'Microsoft JhengHei', sans-serif; background: #121212; color: white; display: flex; overflow: hidden; }
        #ui-panel { width: 300px; padding: 20px; background: rgba(30, 30, 30, 0.9); box-shadow: 2px 0 20px rgba(0,0,0,0.5); z-index: 10; height: 100vh; }
        #canvas-container { flex-grow: 1; height: 100vh; position: relative; }
        .control-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 10px; color: #3498db; font-weight: bold; }
        select { width: 100%; padding: 12px; background: #2c3e50; border: 1px solid #34495e; color: white; border-radius: 8px; cursor: pointer; outline: none; }
        select:hover { border-color: #3498db; }
        h2 { font-size: 1.2rem; border-left: 4px solid #3498db; padding-left: 10px; margin-bottom: 30px; }
        .info { font-size: 0.8rem; color: #888; line-height: 1.6; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #3498db; font-size: 1.2rem; }
    </style>
</head>
<body>

<div id="ui-panel">
    <h2>äººç‰©åŸºç¤è¨­å®š</h2>
    
    <div class="control-group">
        <label>æ€§åˆ¥ (Gender)</label>
        <select id="gender">
            <option value="male">ç”·æ€§ (æ›´æ›ç‚ºç”·æ€§æ¨¡å‹)</option>
            <option value="female" selected>å¥³æ€§ (æ›´æ›ç‚ºå¥³æ€§æ¨¡å‹)</option>
        </select>
    </div>

    <div class="control-group">
        <label>èº«é«˜ (Height)</label>
        <select id="height"></select>
    </div>

    <div class="control-group">
        <label>é«”é‡ (Weight)</label>
        <select id="weight"></select>
    </div>

    <div class="info">
        <p>ğŸ’¡ æ“ä½œèªªæ˜ï¼š<br>
        - æ»‘é¼ å·¦éµï¼šæ—‹è½‰äººç‰©<br>
        - æ»‘é¼ æ»¾è¼ªï¼šç¸®æ”¾è¦–è§’<br>
        - æ»‘é¼ å³éµï¼šç§»å‹•ä½ç½®</p>
    </div>
</div>

<div id="canvas-container">
    <div id="loading">æ­£åœ¨ç”Ÿæˆ 3D æ¨¡æ“¬äººç‰©...</div>
</div>

<script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
    import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/GLTFLoader.js';

    let scene, camera, renderer, model, controls;
    const loader = new GLTFLoader();

    // æ¨¡å‹ç¶²å€ (é€™è£¡ä½¿ç”¨ä¸€å€‹å…¬ç”¨çš„çœŸäººæ¯”ä¾‹æ¨¡å‹ä½œç‚ºå±•ç¤º)
    // ä¹‹å¾Œä½ å¯ä»¥æ›æˆè‡ªå·±çš„ "barbie.glb" æˆ– "avatar.glb"
    const MODELS = {
        female: 'https://threejs.org/examples/models/gltf/Michelle.glb',
        male: 'https://threejs.org/examples/models/gltf/Soldier.glb'
    };

    async function init() {
        // 1. åˆå§‹åŒ–å ´æ™¯
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x121212);

        // 2. åˆå§‹åŒ–ç›¸æ©Ÿ
        camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 300) / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.2, 3);

        // 3. åˆå§‹åŒ–æ¸²æŸ“å™¨
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth - 300, window.innerHeight);
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.shadowMap.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // 4. å…‰ç…§ç’°å¢ƒ (æ¨¡æ“¬äººåƒæ”å½±æ£š)
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
        scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(3, 10, 10);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // 5. è»Œé“æ§åˆ¶ (æ—‹è½‰æª¢è¦–)
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, 1, 0);

        // 6. åˆå§‹åŒ–é¸å–®
        setupDropdowns();
        
        // 7. è¼‰å…¥é è¨­æ¨¡å‹
        loadCharacter('female');

        window.addEventListener('resize', onWindowResize);
        animate();
    }

    function setupDropdowns() {
        const hSel = document.getElementById('height');
        const wSel = document.getElementById('weight');
        const gSel = document.getElementById('gender');

        for(let i=150; i<=180; i++) hSel.add(new Option(`${i} cm`, i));
        for(let i=40; i<=90; i++) wSel.add(new Option(`${i} kg`, i));
        
        hSel.value = 165;
        wSel.value = 55;

        hSel.addEventListener('change', updateBodyShape);
        wSel.addEventListener('change', updateBodyShape);
        gSel.addEventListener('change', (e) => loadCharacter(e.target.value));
    }

    function loadCharacter(gender) {
        if (model) scene.remove(model);
        document.getElementById('loading').style.display = 'block';

        loader.load(MODELS[gender], (gltf) => {
            model = gltf.scene;
            model.traverse(n => { if (n.isMesh) n.castShadow = true; });
            scene.add(model);
            document.getElementById('loading').style.display = 'none';
            updateBodyShape(); // è¼‰å…¥å¾Œç«‹å³å¥—ç”¨ç•¶å‰æ•¸å€¼
        });
    }

    function updateBodyShape() {
        if (!model) return;

        const heightVal = parseInt(document.getElementById('height').value);
        const weightVal = parseInt(document.getElementById('weight').value);

        // --- æ ¸å¿ƒç¸®æ”¾æ¼”ç®—æ³• ---
        // 1. èº«é«˜ (Height): å½±éŸ¿ Y è»¸
        // åŸºæº–è¨­ç‚º 170cm = 1.0
        const scaleY = heightVal / 170;

        // 2. é«”é‡ (Weight): å½±éŸ¿ X è»¸(å¯¬åº¦) èˆ‡ Z è»¸(åšåº¦)
        // åŸºæº–è¨­ç‚º 60kg = 1.0
        // æˆ‘å€‘ä½¿ç”¨ Math.sqrt (å¹³æ–¹æ ¹) è®“é«”é‡å¢åŠ æ™‚çš„è¦–è¦ºæ•ˆæœæ¯”è¼ƒè‡ªç„¶ï¼Œä¸æœƒéåº¦è†¨è„¹
        const scaleXZ = Math.sqrt(weightVal / 60);

        // å¥—ç”¨ç¸®æ”¾
        model.scale.set(scaleXZ, scaleY, scaleXZ);
        
        // åŒæ­¥èª¿æ•´æ¨¡å‹ä½ç½®ï¼Œç¢ºä¿è…³è¸©åœ¨åœ°é¢ä¸Š (æ ¹æ“šç¸®æ”¾æ¯”ä¾‹å¾®èª¿)
        model.position.y = 0; 
    }

    function onWindowResize() {
        camera.aspect = (window.innerWidth - 300) / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth - 300, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    init();
</script>

</body>
</html>
